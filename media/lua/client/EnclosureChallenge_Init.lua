--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
require "lua_timers"

EnclosureChallenge = EnclosureChallenge or {}


EnclosureChallenge.EnclosureSize = 189
EnclosureChallenge.MarkerCache = {}
-----------------------    init*        ---------------------------
--local  ec = EnclosureChallenge.getData()

function EnclosureChallenge.initChallengeData(pl)
    pl = pl or getPlayer()
    if not pl then return end

    local md = pl:getModData()
    md.EnclosureChallenge = md.EnclosureChallenge or {}
    local ec = md.EnclosureChallenge


    ec.UnlockPoints      = ec.UnlockPoints      or SandboxVars.EnclosureChallenge.StartingUnlockPoints or 1
    ec.RewardChoice      = ec.RewardChoice      or 0
   -- ec.RemoteWins        = ec.RemoteWins        or 0
    ec.Challenges        = ec.Challenges        or {}
    ec.Conquered         = ec.Conquered         or {}
    ec.PrevCoord         = {}
    ec.Rebound           = ec.Rebound           or {}

    ec.ChallengeTime     = ec.ChallengeTime     or 0
    ec.RemoteChallenge   = ec.RemoteChallenge   or ""
    ec.AdditiveChallenge = ec.AdditiveChallenge or ""
    return ec
end

Events.OnCreatePlayer.Add(function()
    if not isIngameState() then return end

    local pl = getPlayer()
    if not pl then return end

    EnclosureChallenge.initChallengeData(pl)
    --EnclosureChallenge.setMarkers(pl)
    --EnclosureChallenge.setReturnPointMarker()
    local encStr = EnclosureChallenge.getEnclosureStr(pl)
    EnclosureChallenge.PreviousEnclosure = ""

    EnclosureChallenge.updateMarkers(encStr)

    local  ec = EnclosureChallenge.getData()
    if ec and EnclosureChallenge.isChallenger() and ec.ChallengeTime <= 0 then
        --EnclosureChallenge.addChallengeSymbols(pl)
        --local isRemote = EnclosureChallenge.isRemoteMode()
        EnclosureChallenge.doWin()
    end
end)

Events.OnPlayerDeath.Add(function()
	local pl = getPlayer()
	local user = pl:getUsername()
	if not EnclosureChallenge.isChallenger()  then return end
	if EnclosureChallenge.isShouldAnnounce() then



	    local enc = EnclosureChallenge.getEnclosureXY(  pl:getX(),   pl:getY())
        if not enc then return end

        local encStr = EnclosureChallenge.getEnclosureStr(pl)
		local posStr = (enc.x and enc.y) and ": [" .. tostring(encStr) .. "]" or ""
		if not SandboxVars.EnclosureChallenge.CoordNotif then
			posStr = ""
		end

		local msg = tostring(user) .. " " .. getText("ContextMenu_EnclosureChallenge_Fail").. "  ".. tostring(posStr)
		if isClient() then
			processGeneralMessage(msg)
		else
			pl:setHaloNote(msg, 150, 250, 150, 900)
		end
	end
	--EnclosureChallenge.setChallenge(false, false)
end)



--[[ Events.OnCreatePlayer.Add(function()
    if isIngameState() then
        local pl = getPlayer()
        if not pl then return end

        EnclosureChallenge.initChallengeData(pl)
        EnclosureChallenge.setMarkers(pl)

        local encStr  = EnclosureChallenge.getEnclosureStr(pl)
        EnclosureChallenge.PreviousEnclosure = encStr
        triggerEvent("OnEnclosureChange", EnclosureChallenge.PreviousEnclosure,  encStr)

	end
end)
 ]]
-----------------------       ---------------------------



--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]
