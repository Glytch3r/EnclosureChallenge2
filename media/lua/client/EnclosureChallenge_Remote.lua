--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

--EnclosureChallenge_Remote.lua
EnclosureChallenge = EnclosureChallenge or {}
-----------------------   remote challenge        ---------------------------

function EnclosureChallenge.goBack()
	local pl = getPlayer()
	if not pl then return end
	local ec = EnclosureChallenge.getData()
	local p = ec.PrevCoord
	if p and p.x and p.y and p.z then
		EnclosureChallenge.tp(pl, p.x, p.y, p.z)
	end

	--ec.PrevCoord = nil
end
function EnclosureChallenge.clearCoord()
	local pl = getPlayer()
	if not pl then return end
	local ec = pl:getModData().EnclosureChallenge
	ec.PrevCoord = nil
end
function EnclosureChallenge.saveCoord()
    local pl = getPlayer()
    if not pl then return end
	local ec = EnclosureChallenge.getData()

    ec.PrevCoord = {x= round(pl:getX()), y = round(pl:getY()), z= pl:getZ()}
end


function EnclosureChallenge.isValidSq(sq)
    sq = sq or getPlayer():getCurrentSquare()
    return sq and sq:connectedWithFloor() and sq:getFloor() ~= nil
end
-----------------------            ---------------------------

function EnclosureChallenge.getRandMidCoord()
    local size = EnclosureChallenge.EnclosureSize or 189

    local mapAPI = ISWorldMap_instance.javaObject:getAPIv1()
    local width = mapAPI:getWidthInSquares() - 1
    local height = mapAPI:getHeightInSquares() - 1

    local maxEncX = math.floor(width / size)
    local maxEncY = math.floor(height / size)

    local encX = ZombRand(0, maxEncX + 1)
    local encY = ZombRand(0, maxEncY + 1)

    local midX = (encX * size) + math.floor(size / 2)
    local midY = (encY * size) + math.floor(size / 2)

    return midX, midY, encX, encY
end

function EnclosureChallenge.tpRandMidSq()
    local pl = getPlayer()
    if EnclosureChallenge.isChallenger(pl) then return end

    local waitTicks = 60
    local maxTicks = 300
    local maxAttempts = math.floor(maxTicks / waitTicks)

    local rTick = 0
    local attemptCount = 0

    local midX, midY, encX, encY = EnclosureChallenge.getRandMidCoord()
    EnclosureChallenge.tp(pl, midX, midY, 0)

    EnclosureChallenge.tpHandler = function()
        rTick = rTick + 1
        if rTick % waitTicks ~= 0 then return end

        local sq = pl:getSquare()
        if not EnclosureChallenge.isValidSq(sq) then
            attemptCount = attemptCount + 1
            if attemptCount >= maxAttempts then
                pl:Say("Unable to find valid location.")
                EnclosureChallenge.goBack()
                Events.OnTick.Remove(EnclosureChallenge.tpHandler)
                return
            end

            midX, midY, encX, encY = EnclosureChallenge.getRandMidCoord()
            EnclosureChallenge.tp(pl, midX, midY, 0)
            rTick = 0
            return
        end

        EnclosureChallenge.ConfirmDialog(pl, "Accept Remote Challenge?", "Enclosure Challenge", false, true)
        Events.OnTick.Remove(EnclosureChallenge.tpHandler)
    end

    Events.OnTick.Add(EnclosureChallenge.tpHandler)
end


-----------------------            ---------------------------

--[[
function EnclosureChallenge.tpRandMidSq()
    local pl = getPlayer()
    if EnclosureChallenge.isChallenger(pl) then return end

    local rTick = 0
    local waitTicks = 60
    local maxTicks = 300
    local maxAttempts = math.floor(maxTicks / waitTicks)
    local attemptCount = 0

    local midX, midY, EnclosureX, EnclosureY = EnclosureChallenge.getRandMidCoord()

    EnclosureChallenge.tp(pl, midX, midY)

    function EnclosureChallenge.tpHandler()
        rTick = rTick + 1
        if rTick % waitTicks == 0 then
            local sq = pl:getSquare()
            if rTick >= waitTicks then
                if not EnclosureChallenge.isValidSq(sq) then
                    attemptCount = attemptCount + 1
                    if attemptCount >= maxAttempts then
                        pl:Say("Unable to find valid location.")
                        EnclosureChallenge.goBack()
                        Events.OnTick.Remove(EnclosureChallenge.tpHandler)
                        return
                    end
                    midX, midY, EnclosureX, EnclosureY = EnclosureChallenge.getRandMidCoord()
                    EnclosureChallenge.tp(pl, midX, midY)
                    rTick = 0
                    return
                end

                local data = pl:getModData()
                if not data.EnclosureChallenge then
                    data.EnclosureChallenge = {}
                end
                data.EnclosureChallenge.EnclosureX = EnclosureX
                data.EnclosureChallenge.EnclosureY = EnclosureY

                if isClient() then
                    sendClientCommand("EnclosureChallenge", "prompt", {
                        EnclosureX = EnclosureX,
                        EnclosureY = EnclosureY,
                        isRemote = true
                    })
                end

                EnclosureChallenge.ConfirmDialog(pl, "Accept Remote Challenge?", "Enclosure Challenge", false, true)
                Events.OnTick.Remove(EnclosureChallenge.tpHandler)
            end
        end
    end

    Events.OnTick.Add(EnclosureChallenge.tpHandler)
end

 ]]