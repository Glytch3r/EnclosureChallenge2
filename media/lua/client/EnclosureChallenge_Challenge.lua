--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

EnclosureChallenge = EnclosureChallenge or {}

function EnclosureChallenge.setChallenge(isStart, isRemote)
    local pl = getPlayer()
    if not pl then return end

    local ec = EnclosureChallenge.getData()
    if not ec then return end

    isRemote = isRemote or EnclosureChallenge.isRemoteMode(pl)

    if isStart then
        ec.ChallengeTime = SandboxVars.EnclosureChallenge.ChallengeHours or 168


        local x = round(pl:getX())
        local y = round(pl:getY())
        local z = pl:getZ() or 0


        EnclosureChallenge.setMarkers(pl, false)
        EnclosureChallenge.addChallengeSymbols(pl)

    else

        ec.AdditiveChallenge = ""
        ec.RemoteChallenge =  ""
        EnclosureChallenge.setMarkers(pl, false)

        EnclosureChallenge.delReturnPointMarker()
        ec.ChallengeTime = 0
    end
end

        --EnclosureChallenge.clearRebound(pl)
--[[
        if EnclosureChallenge.isConquered(pl) then
            EnclosureChallenge.addChallengeSymbols(pl)
        end
 ]]
function EnclosureChallenge.doWin(isRemote)
    local pl = getPlayer(); if not pl then return end
    isRemote =  isRemote or EnclosureChallenge.isRemoteMode(pl)


    --EnclosureChallenge.rebound(pl)
    timer:Simple(1, function()
        EnclosureChallenge.doReward();
        EnclosureChallenge.storeConquered(isRemote)
        EnclosureChallenge.delReturnPointMarker()

        EnclosureChallenge.setChallenge(false, isRemote)
        EnclosureChallenge.setMarkers(pl, false)
        EnclosureChallenge.addChallengeSymbols(pl)

      --  local rewards = SandboxVars.EnclosureChallenge.UnlockPointsReward


        local ec = EnclosureChallenge.getData()
        EnclosureChallenge.clearRebound(pl)
        getSoundManager():playUISound("GainExperienceLevel")
    end)


end

function EnclosureChallenge.storeConquered(isRemote)
	local pl = getPlayer()
	local ec = EnclosureChallenge.getData()
	local x, y = ec.Rebound.x, ec.Rebound.y
	local z = pl:getZ()
	local encStr = ec.AdditiveChallenge or EnclosureChallenge.getEnclosureStrXY(x, y) or EnclosureChallenge.getEnclosureStr(pl)
	isRemote = isRemote or EnclosureChallenge.isRemoteMode(pl)

	if isRemote then
        ec.RemoteChallenge = ""
		ec.RemoteWins = ec.RemoteWins + 1
		HaloTextHelper.addTextWithArrow(pl, "Remote Wins + 1", true, HaloTextHelper.getColorGreen())

	else
        local rewards = SandboxVars.EnclosureChallenge.UnlockPointsReward
		ec.UnlockPoints = ec.UnlockPoints + rewards
		HaloTextHelper.addTextWithArrow(pl, "Unlock Points + 1", true, HaloTextHelper.getColorGreen())
		local sq = getCell():getOrCreateGridSquare(x, y, z)
		if sq then
			EnclosureChallenge.addChallengeSymbols(sq)
		end
		ec.Conquered = ec.Conquered or {}
		ec.Conquered[encStr] = true
	end

	EnclosureChallenge.clearRebound()
	return true
end


-----------------------            ---------------------------


function EnclosureChallenge.isChallenger(pl)
    pl = pl or getPlayer()
    local ec = EnclosureChallenge.getData()
    if not ec then return false end
    return ec.ChallengeTime and ec.ChallengeTime > 0 and ((ec.AdditiveChallenge ~= "" and ec.AdditiveChallenge ~= nil) or (ec.RemoteChallenge ~= "" and ec.RemoteChallenge ~= nil))
end

function EnclosureChallenge.isAdditiveMode(pl)
    pl = pl or getPlayer()
    if EnclosureChallenge.isChallenger(pl) then
        local ec = EnclosureChallenge.getData()
        if not ec then return false end
        return ec.AdditiveChallenge ~= nil and ec.AdditiveChallenge ~= ""
    end
    return false
end
function EnclosureChallenge.isRemoteMode(pl)
    pl = pl or getPlayer()
    if EnclosureChallenge.isChallenger(pl) then
        local ec = EnclosureChallenge.getData()
        if not ec then return false end
        return ec.RemoteChallenge ~= nil and ec.RemoteChallenge ~= ""
    end
    return false
end

function EnclosureChallenge.getChallengeTime(pl)
    pl = pl or getPlayer()
    local ec = EnclosureChallenge.getData()
    if not ec then return 0 end
    ec.ChallengeTime = ec.ChallengeTime or 0
    return ec.ChallengeTime
end








function EnclosureChallenge.getChallengeTimeStr()
    local pl = getPlayer()
    local str = ""
    if EnclosureChallenge.isChallenger(pl) then
        local time = EnclosureChallenge.getChallengeTime(pl)
        if time and time > 0 then
            if time == 1 then
                str = "Final Hour"
            else
                str = "Hours Remaining: " .. tostring(time)
            end
        end
    end
    return str
end



function EnclosureChallenge.getChallenges()
    local ec = EnclosureChallenge.getData()
    if not ec then return nil end
    ec.Challenges = ec.Challenges or {}
    return ec.Challenges
end

function EnclosureChallenge.isConquered(targ)
	local ec = EnclosureChallenge.getData()
	ec.Conquered = ec.Conquered or {}


	local str = EnclosureChallenge.getEnclosureStr(targ)
	if not str then return false end

	return ec.Conquered[str] == true
end
-----------------------            ---------------------------


function EnclosureChallenge.isUnlocked(targ)
    local ec = EnclosureChallenge.getData()
    ec.Challenges = ec.Challenges or {}

    local str = EnclosureChallenge.getEnclosureStr(targ)
    return str and ec.Challenges[str] == true or false
end
-----------------------            ---------------------------
function EnclosureChallenge.isCanUnlock(targ)
    local pl = getPlayer()
    if EnclosureChallenge.isChallenger(pl) then return false end
    if not EnclosureChallenge.isUnlocked(targ) and not EnclosureChallenge.isConquered(targ) then
        local ec = EnclosureChallenge.getData()
        if not ec or not ec.UnlockPoints then return false end
        return ec.UnlockPoints > 0
    end
    return false
end

-----------------------            ---------------------------
function EnclosureChallenge.storeEnclosure(targ)

    local ec = EnclosureChallenge.getData()
    local str = EnclosureChallenge.getEnclosureStr(targ)
    local isRemote =  EnclosureChallenge.isRemoteMode(targ)

    if isRemote then
        return
    else
        ec.Challenges = ec.Challenges or {}
        ec.Challenges[str] = true
        print("Enclosure stored successfully")
    end
    return true
end


-----------------------            ---------------------------
function EnclosureChallenge.doUnlock(targ)
    local pl = getPlayer()
    targ = targ or pl

    if not EnclosureChallenge.isCanUnlock(targ) then return false end

	local encStr = EnclosureChallenge.getEnclosureStr(targ)

    local ec = EnclosureChallenge.getData()
    if not ec or not ec.UnlockPoints or ec.UnlockPoints <= 0 then
        print("err not enough points")
        return false
    end

    ec.UnlockPoints = ec.UnlockPoints - 1
    pl:playSound("GarageDoorUnlock")

    EnclosureChallenge.storeEnclosure(targ)

    EnclosureChallenge.addChallengeSymbols(targ)
    return true
end

-----------------------            ---------------------------
