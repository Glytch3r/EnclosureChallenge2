--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

EnclosureChallenge = EnclosureChallenge or {}


function EnclosureChallenge.setChallenge(isStart, isRemote)
	local pl = getPlayer()
	if not pl then return end
    isRemote =  isRemote or EnclosureChallenge.isRemoteMode(pl)
    EnclosureChallenge.storeEnclosure(pl)
	if isStart then
        local hours = SandboxVars.EnclosureChallenge.ChallengeHours or 168
		ec.ChallengeTime = hours
        if isRemote then
            EnclosureChallenge.setRemoteMode(true)
        end
	else --end
        if isRemote then
            EnclosureChallenge.setRemoteMode(false)
        end
		ec.ChallengeTime = 0
	end
end


function EnclosureChallenge.doWin()
    local pl = getPlayer(); if not pl then return end
    EnclosureChallenge.doReward();
    local isRemote =  EnclosureChallenge.isRemoteMode(pl)
    EnclosureChallenge.setChallenge(false, isRemote)
    EnclosureChallenge.storeConquered(isRemote)
    EnclosureChallenge.setMarkers(pl, false)

    getSoundManager():playUISound("GainExperienceLevel")

end
function EnclosureChallenge.storeConquered(isRemote)
    local pl = getPlayer()
    local ec = EnclosureChallenge.getData()
	x = ec.Rebound.x
    y = ec.Rebound.y
    local encStr = EnclosureChallenge.getEnclosureStrXY(x, y)
    isRemote = isRemote or EnclosureChallenge.isRemoteMode(pl)

    if isRemote then
        EnclosureChallenge.setRemoteMode(false)
        ec.RemoteWins = ec.RemoteWins + 1
        HaloTextHelper.addTextWithArrow(pl, "Remote Wins + 1", true, HaloTextHelper.getColorGreen())

    else
        ec.UnlockPoints = ec.UnlockPoints + 1
        HaloTextHelper.addTextWithArrow(pl, "Unlock Points + 1", true, HaloTextHelper.getColorGreen())
        local sq = getCell():getOrCreateGridSquare(x, y, z)
        if sq then
            EnclosureChallenge.addChallengeSymbols(sq)
        end
        ec.Conquered = ec.Conquered or {}
        ec.Conquered[encStr] = true
    end
    EnclosureChallenge.clearRebound()
    return true
end

function EnclosureChallenge.setRemoteMode(active)
    local pl = getPlayer()
    local ec = EnclosureChallenge.getData()
    if not ec then return end

    if active then
        ec.RemoteChallenge = EnclosureChallenge.getEnclosureStr(pl)
    else
        ec.RemoteChallenge = ""
    end
end
-----------------------            ---------------------------


function EnclosureChallenge.isChallenger(pl)
    pl = pl or getPlayer()
    local ec = EnclosureChallenge.getData()
    if not ec then return false end
    return ec.ChallengeTime and ec.ChallengeTime > 0
end

function EnclosureChallenge.isRemoteMode(pl)
    pl = pl or getPlayer()
    if EnclosureChallenge.isChallenger(pl) then
        local ec = EnclosureChallenge.getData()
        if not ec then return false end
        return ec.RemoteChallenge ~= nil and ec.RemoteChallenge ~= ""
    end
    return false
end
function EnclosureChallenge.setRemoteMode(active)
    local pl = getPlayer()
    local ec = EnclosureChallenge.getData()
    if not ec then return end

    if active then
        ec.RemoteChallenge = EnclosureChallenge.getEnclosureStr(pl)
    else
        ec.RemoteChallenge = ""
    end
end

function EnclosureChallenge.getChallengeTime(pl)
    pl = pl or getPlayer()
    local ec = EnclosureChallenge.getData()
    if not ec then return 0 end
    ec.ChallengeTime = ec.ChallengeTime or 0
    return ec.ChallengeTime
end

function EnclosureChallenge.challengeStats()
    local pl = getPlayer()
    local str = ""

    local ec = EnclosureChallenge.getdata()
    if not ec then return end

    str = "\nConquered: " .. tostring(#ec.Conquered)
    str = "\nRemote Wins: " .. tostring(ec.RemoteWins)
    str = tostring(str).. "\nUnlocked: " .. tostring(#ec.Challenges)
    str = tostring(str).. "\nPoints: " .. tostring(ec.UnlockPoints)
    str = tostring(str).. "\nReward: " .. tostring(ec.RewardChoice)

    if EnclosureChallenge.isChallenger(pl) then
        if ec.ChallengeTime > 0 then
            if time == 1 then
                str = tostring(str).. "\nFinal Hour"
            else
                str = tostring(str).. "\nHours Remaining: " .. tostring(ec.ChallengeTime)
            end
        end
    end

    --ec.Rebound

    return str

end





function EnclosureChallenge.getChallengeTimeStr()
    local pl = getPlayer()
    local str = ""
    if EnclosureChallenge.isChallenger(pl) then
        local time = EnclosureChallenge.getChallengeTime(pl)
        if time and time > 0 then
            if time == 1 then
                str = "Final Hour"
            else
                str = "Hours Remaining: " .. tostring(time)
            end
        end
    end
    return str
end



function EnclosureChallenge.getChallenges()
    local ec = EnclosureChallenge.getData()
    if not ec then return nil end
    ec.Challenges = ec.Challenges or {}
    return ec.Challenges
end
-----------------------            ---------------------------
function EnclosureChallenge.isCanUnlock(targ)
    if EnclosureChallenge.isChallenger(targ) then return false end
    if not EnclosureChallenge.isUnlocked(targ) and not EnclosureChallenge.isConquered(targ) then
        local ec = EnclosureChallenge.getData()
        if not ec or not ec.UnlockPoints then return false end
        return ec.UnlockPoints > 0
    end
    return false
end

-----------------------            ---------------------------
function EnclosureChallenge.isConquered(targ)
	local ec = EnclosureChallenge.getData()
	ec.Conquered = ec.Conquered or {}


	local str = EnclosureChallenge.getEnclosureStr(targ)
	if not str then return false end

	return ec.Conquered[str] == true
end


function EnclosureChallenge.isUnlocked(targ)
    local ec = EnclosureChallenge.getData()
    ec.Challenges = ec.Challenges or {}

    local str = EnclosureChallenge.getEnclosureStr(targ)
    return str and ec.Challenges[str] == true or false
end

function EnclosureChallenge.storeEnclosure(targ)

    local ec = EnclosureChallenge.getData()
    local str = EnclosureChallenge.getEnclosureStr(targ)
    local isRemote =  EnclosureChallenge.isRemoteMode(targ)

    if isRemote then
        return
    else
        ec.Challenges = ec.Challenges or {}
        ec.Challenges[str] = true
        print("Enclosure stored successfully")
    end
    return true
end


-----------------------            ---------------------------
function EnclosureChallenge.doUnlock(targ)
    local pl = getPlayer()
    targ = targ or pl

    if not EnclosureChallenge.isCanUnlock(targ) then return false end

    local ec = EnclosureChallenge.getData()
    if not ec or not ec.UnlockPoints or ec.UnlockPoints <= 0 then
        print("err not enough points")
        return false
    end

    ec.UnlockPoints = ec.UnlockPoints - 1
    pl:playSound("GarageDoorUnlock")

    EnclosureChallenge.storeEnclosure(targ)

    EnclosureChallenge.addChallengeSymbols(targ)
    return true
end

-----------------------            ---------------------------
