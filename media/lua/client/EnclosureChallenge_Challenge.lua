--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]
require "lua_timers"

EnclosureChallenge = EnclosureChallenge or {}

-----------------------            ---------------------------


-----------------------            ---------------------------


function EnclosureChallenge.isChallenger()
    return (EnclosureChallenge.isRemoteMode() or EnclosureChallenge.isAdditiveMode())
end


function EnclosureChallenge.getChallengeTime()
    local ec = EnclosureChallenge.getData()
    if not ec then return 0 end
    ec.ChallengeTime = ec.ChallengeTime or 0
    return ec.ChallengeTime
end

function EnclosureChallenge.isAdditiveMode()
    local ec = EnclosureChallenge.getData()
    if not ec then return false end
    return (ec.AdditiveChallenge ~= nil and ec.AdditiveChallenge ~= "") or false
end
function EnclosureChallenge.isRemoteMode()
    local ec = EnclosureChallenge.getData()
    if not ec then return false end
    return (ec.RemoteChallenge ~= nil and ec.RemoteChallenge ~= "") or false
end

function EnclosureChallenge.getModeStr()
    if EnclosureChallenge.isChallenger() then
        if EnclosureChallenge.isAdditiveMode() then return "Additive Mode" end
        if EnclosureChallenge.isRemoteMode() then return "Remote Mode" end
    end
    return ""
end



function EnclosureChallenge.getAdditiveChallenge()
    local ec = EnclosureChallenge.getData()
    if not ec then return 0 end
    ec.RemoteChallenge = ec.RemoteChallenge or ""
    return ec.RemoteChallenge
end

function EnclosureChallenge.getRemoteChallenge()
    local ec = EnclosureChallenge.getData()
    if not ec then return 0 end
    ec.RemoteChallenge = ec.RemoteChallenge or ""
    return ec.RemoteChallenge
end



-----------------------            ---------------------------

function EnclosureChallenge.getChallengeTimeStr()
    local pl = getPlayer()
    local str = ""
    if EnclosureChallenge.isChallenger() then
        local time = EnclosureChallenge.getChallengeTime()
        if time and time > 0 then
            if time == 1 then
                str = "Final Hour"
            else
                str = "Hours Remaining: " .. tostring(time)
            end
        end
    end
    return str
end



function EnclosureChallenge.getChallenges()
    local ec = EnclosureChallenge.getData()
    if not ec then return nil end
    ec.Challenges = ec.Challenges or {}
    return ec.Challenges
end

function EnclosureChallenge.isConquered(targ)
	local ec = EnclosureChallenge.getData()
	ec.Conquered = ec.Conquered or {}


	local str = EnclosureChallenge.getEnclosureStr(targ)
	if not str then return false end

	return ec.Conquered[str] == true
end
-----------------------            ---------------------------


function EnclosureChallenge.isUnlocked(targ)
    local ec = EnclosureChallenge.getData()
    ec.Challenges = ec.Challenges or {}

    local str = EnclosureChallenge.getEnclosureStr(targ)
    return str and ec.Challenges[str] == true or false
end
-----------------------            ---------------------------
function EnclosureChallenge.isCanUnlock(targ)
    local pl = getPlayer()
    if EnclosureChallenge.isChallenger() then return false end
    if not EnclosureChallenge.isUnlocked(targ) and not EnclosureChallenge.isConquered(targ) then
        local ec = EnclosureChallenge.getData()
        if not ec or not ec.UnlockPoints then return false end
        return ec.UnlockPoints > 0
    end
    return false
end
-----------------------            ---------------------------
-----------------------            ---------------------------
function EnclosureChallenge.storeEnclosure(targ)

    local ec = EnclosureChallenge.getData()
    local str = EnclosureChallenge.getEnclosureStr(targ)
    local isRemote =  EnclosureChallenge.isRemoteMode(targ)

    if isRemote then
        return
    else
        ec.Challenges = ec.Challenges or {}
        ec.Challenges[str] = true
        print("Enclosure stored successfully")
    end
    return true
end
function EnclosureChallenge.getChallengeCount()
    local ec = EnclosureChallenge.getData()
    local tab = ec and ec.Challenges
    if not tab then return 0 end
    local count = 0
    for _ in pairs(tab) do
        count = count + 1
    end
    return count
end

-----------------------            ---------------------------
function EnclosureChallenge.doUnlock(targ)
    local pl = getPlayer()
    targ = targ or pl

    if not EnclosureChallenge.isCanUnlock(targ) then return false end

	local encStr = EnclosureChallenge.getEnclosureStr(targ)

    local ec = EnclosureChallenge.getData()
    if not ec or not ec.UnlockPoints or ec.UnlockPoints <= 0 then
        print("err not enough points")
        return false
    end

    ec.UnlockPoints = ec.UnlockPoints - 1
    HaloTextHelper.addTextWithArrow(pl, "Unlock Points - 1", false, HaloTextHelper.getColorRed())
    pl:playSound("GarageDoorUnlock")

    EnclosureChallenge.storeEnclosure(targ)

    EnclosureChallenge.addChallengeSymbols(targ)
    return true
end

-----------------------            ---------------------------

function EnclosureChallenge.storeConquered(isRemote)
    local pl = getPlayer(); if not pl then return false end
    local ec = EnclosureChallenge.getData()
    if not ec then return false end
    local rebound = ec.Rebound
    if not rebound or not rebound.x or not rebound.y then return false end

    local x, y, z = rebound.x, rebound.y, rebound.z

    if isRemote or (ec.RemoteChallenge and ec.RemoteChallenge ~= "") then
        ec.RemoteWins = (ec.RemoteWins or 0) + 1
        HaloTextHelper.addTextWithArrow(pl, "Remote Wins + 1", true, HaloTextHelper.getColorGreen())
    end

    if (not isRemote) or (ec.AdditiveChallenge and ec.AdditiveChallenge ~= "") then
        local encStr = tostring(ec.AdditiveChallenge) or EnclosureChallenge.getEnclosureStrXY(x, y) or EnclosureChallenge.getEnclosureStr(pl)
        if not encStr then return false end

        local reward = SandboxVars.EnclosureChallenge.UnlockPointsReward or 1
        ec.UnlockPoints = (ec.UnlockPoints or 0) + reward

        HaloTextHelper.addTextWithArrow(pl, "Unlock Points + " .. tostring(reward), true, HaloTextHelper.getColorGreen())

        local sq = getCell():getOrCreateGridSquare(x, y, z)
        if sq then EnclosureChallenge.addChallengeSymbols(sq) end

        ec.Conquered = ec.Conquered or {}
        ec.Conquered[encStr] = true
    end

    return true
end

function EnclosureChallenge.getConqueredCount()
    local ec = EnclosureChallenge.getData()
    local tab = ec and ec.Conquered
    if not tab then return 0 end
    local count = 0
    for _ in pairs(tab) do
        count = count + 1
    end
    return count
end
