--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

EnclosureChallenge = EnclosureChallenge or {}
-----------------------     sub*          ---------------------------

function EnclosureChallenge.addCategorySubmenu(context, rootMenu, worldobjects)
    local pl = getPlayer(); if not pl then return end

    local currentChoice = EnclosureChallenge.getRewardChoice()
    local subOpt = rootMenu:addOption(getText("ContextMenu_EnclosureChallenge_ChooseCategory"))
    subOpt.iconTexture = getTexture("media/ui/EnclosureChallenge_Rewards.png")

    local categSub = ISContextMenu:getNew(context)
    context:addSubMenu(subOpt, categSub)

    for i = 0, 14 do
        local title = EnclosureChallenge.getRewardTitle(i)
        if i == 0 or (title and title ~= "") then
            local label = (i == 0) and getText("Random") or tostring(title)
            local chance = EnclosureChallenge.getRewardChance(i)

            local opt = categSub:addOption(label, worldobjects, function()
                EnclosureChallenge.setRewardChoice(i)
                getSoundManager():playUISound("UIActivateMainMenuItem")
                context:hideAndChildren()
            end)

            local tip = ISWorldObjectContextMenu.addToolTip()
            if i == 0 then
                tip.description = "100% Chance to win a random item across all categories"
            else
                tip.description = "Reward Chance: " .. tostring(chance)
                local items = EnclosureChallenge.parseItems(i)
                if #items > 0 then
                    tip.description = tip.description .. "\nItems:\n- " .. table.concat(items, "\n- ")
                end
            end

            opt.toolTip = tip
            if i == currentChoice then
                categSub:setOptionChecked(opt, true)
            end
        end
    end
end
-----------------------     context*          ---------------------------

function EnclosureChallenge.Context(plNum, context, worldobjects)
    local pl = getSpecificPlayer(plNum)
    local sq = clickedSquare
    if not pl or not sq then return end

    local ec = EnclosureChallenge.getData()
    local isChallenger = EnclosureChallenge.isChallenger()
    local encStr = EnclosureChallenge.getEnclosureStr(sq)
    local timeStr = EnclosureChallenge.getTimeStr()

    local mainLabel = getText("ContextMenu_EnclosureChallenge")
    local mainOpt = context:addOptionOnTop(mainLabel)
    mainOpt.iconTexture = getTexture("media/ui/EnclosureChallenge_Icon.png")
    local rootMenu = ISContextMenu:getNew(context)
    context:addSubMenu(mainOpt, rootMenu)

    ----------------------- unlock* ---------------------------
    local status = EnclosureChallenge.getEnclosureStatus(sq)
    local isUnlocked = status == "Unlocked"
    local isConquered = status == "Conquered"
    local isCanUnlock = EnclosureChallenge.isCanUnlock(sq)
--[[
    local unlockLabel = isUnlocked
        and ("UNLOCKED: [  Points: " .. tostring(EnclosureChallenge.getPoints()) .. " ]")
        or (getText("ContextMenu_EnclosureChallenge_Unlock") .. " [  Points: " .. tostring(EnclosureChallenge.getPoints()) .. " ]")
 ]]
	if not isUnlocked then
		local unlockOpt = rootMenu:addOption("Unlock "..tostring(encStr).." ?", worldobjects, function()
			EnclosureChallenge.ConfirmDialog(pl, getText("ContextMenu_EnclosureChallenge_Unlock"), "Enclosure Challenge", false, false, sq)
			context:hideAndChildren()
		end)
		unlockOpt.notAvailable = not isCanUnlock
	else
		local unlockOpt = rootMenu:addOption("Unlocked", worldobjects,nil )
		unlockOpt.notAvailable = true
	end

    ----------------------- additive* ---------------------------
    local clickedOutside = not EnclosureChallenge.isSameEnclosure(sq)
    local startHereOpt = rootMenu:addOption(getText("ContextMenu_EnclosureChallenge_StartHere"), worldobjects, function()
        EnclosureChallenge.ConfirmDialog(pl, "Accept Challenge?", "Enclosure Challenge", false, false)
        context:hideAndChildren()
    end)

    local startHereTip = ISWorldObjectContextMenu.addToolTip()
    if not isUnlocked then
        startHereTip.description = getText("ContextMenu_EnclosureChallenge_MustUnlock")
    elseif isChallenger then
        startHereTip.description = getText("ContextMenu_EnclosureChallenge_Time") .. tostring(timeStr)
    else
        startHereTip.description = getText("ContextMenu_EnclosureChallenge_Confirm") .. " [" .. tostring(encStr) .. "]"
    end

    startHereOpt.notAvailable = clickedOutside or not isUnlocked or isChallenger or isConquered
    startHereOpt.toolTip = startHereTip

    ----------------------- remote* ---------------------------
    if not isChallenger and SandboxVars.EnclosureChallenge.AllowRemoteChallenge then
        local remoteOpt = rootMenu:addOption(getText("ContextMenu_EnclosureChallenge_StartRemote"), worldobjects, function()
            EnclosureChallenge.saveCoord()
            EnclosureChallenge.tpRandMidSq()
            context:hideAndChildren()
        end)

        local remoteTip = ISWorldObjectContextMenu.addToolTip()
        remoteTip.description = getText("ContextMenu_EnclosureChallenge_StartRemote_tip")
        remoteOpt.toolTip = remoteTip
    end

    ----------------------- quit* ---------------------------
    if isChallenger and SandboxVars.EnclosureChallenge.AllowQuit then
        local quitOpt = rootMenu:addOption(getText("ContextMenu_EnclosureChallenge_Quit"), worldobjects, function()
            EnclosureChallenge.ConfirmDialog(pl, "Forfeit Challenge", "Enclosure Challenge", true, false)
            context:hideAndChildren()
        end)

        local quitTip = ISWorldObjectContextMenu.addToolTip()
        quitTip.description = getText("ContextMenu_EnclosureChallenge_Quit_tip")
        quitOpt.toolTip = quitTip
    end

    ----------------------- info ---------------------------
    if encStr then
        local cellInfo = getText("ContextMenu_EnclosureChallenge_Cell") .. " " .. tostring(encStr)
        local cellOpt = rootMenu:addOptionOnTop(cellInfo, nil, nil)
        cellOpt.notAvailable = true
    end



	-----------------------            ---------------------------
	local guiMenu = rootMenu:addOption("GUI Settings")
	local guiSub = ISContextMenu:getNew(context)
	context:addSubMenu(guiMenu, guiSub)


	local xpMenu = guiSub:addOption("X Percent")
	local xpSub = ISContextMenu:getNew(context)
	context:addSubMenu(xpMenu, xpSub)

	local ypMenu = guiSub:addOption("Y Percent")
	local ypSub = ISContextMenu:getNew(context)
	context:addSubMenu(ypMenu, ypSub)




	local sMenu = guiSub:addOption("Header Space")
	local tSub = ISContextMenu:getNew(context)
	context:addSubMenu(sMenu, tSub)





	local guiSettings = EnclosureChallenge.getGUISettings()
	guiSettings = guiSettings or {}
	for i = 1, 10 do

		local pick = i * 10
		local label = tostring(pick) .. " %"



		local checkxp = xpSub:addOption(label, worldobjects, function()
			guiSettings.xPercentPos = pick
			context:hideAndChildren()
			getSoundManager():playUISound("UIActivateMainMenuItem")
		end)
		context:setOptionChecked(checkxp, guiSettings.xPercentPos == pick)

		local checkyp = ypSub:addOption(label, worldobjects, function()
			guiSettings.yPercentPos = pick
			context:hideAndChildren()
			getSoundManager():playUISound("UIActivateMainMenuItem")
		end)
		context:setOptionChecked(checkyp, guiSettings.yPercentPos == pick)


		local checkt =  tSub:addOption( tostring(round(i*4*3.5)) , worldobjects, function()
			guiSettings.textGap = round(i*4*3.5)
			context:hideAndChildren()
			getSoundManager():playUISound("UIActivateMainMenuItem")
		end)
		context:setOptionChecked(checkt, guiSettings.textGap == pick)




	end

    ----------------------- category submenu ---------------------------
    EnclosureChallenge.addCategorySubmenu(context, rootMenu, worldobjects)

    ----------------------- dbg* ---------------------------
    if getCore():getDebug() then
        local dbgOpt = rootMenu:addOption("Debug")
        local dbgSub = ISContextMenu:getNew(context)
        context:addSubMenu(dbgOpt, dbgSub)

        dbgSub:addOption("clipWhereami", worldobjects, EnclosureChallenge.clipWhereami)
        dbgSub:addOption("dbgWin - set hrs to 0", worldobjects, EnclosureChallenge.dbgWin)
        dbgSub:addOption("dbgPts", worldobjects, EnclosureChallenge.dbgPts)
        dbgSub:addOption("debugData", worldobjects, EnclosureChallenge.debugData)
        dbgSub:addOption("resetData", worldobjects, EnclosureChallenge.resetData)
        dbgSub:addOption("setMarkers [keep old]", worldobjects, function() EnclosureChallenge.setMarkers(sq, true) end)
        dbgSub:addOption("setMarkers [clear old]", worldobjects, function() EnclosureChallenge.setMarkers(sq, false) end)
        dbgSub:addOption("storeRebound", worldobjects, function() EnclosureChallenge.storeRebound(pl) end)
        dbgSub:addOption("doReward", worldobjects, EnclosureChallenge.doReward)
        dbgSub:addOption("addChallengeSymbols", worldobjects, function() EnclosureChallenge.addChallengeSymbols(sq) end)
        dbgSub:addOption("rebound", worldobjects, function() EnclosureChallenge.rebound() end)
        dbgSub:addOption("clearRebound", worldobjects, EnclosureChallenge.clearRebound)
        dbgSub:addOption("storeConquered", worldobjects, function() EnclosureChallenge.storeConquered(true) end)
        dbgSub:addOption("disabler false", worldobjects, function() EnclosureChallenge.disabler(false) end)
    end
end

function EnclosureChallenge.confirmUnlock(button)
    local dialog = button.parent
    if button.internal == "YES" then
        local pl = dialog.pl
        local sq = dialog.sq

        if pl and sq then
            local encStr = EnclosureChallenge.getEnclosureStr(sq)
            if encStr then
                local ec = pl:getModData().EnclosureChallenge or {}
                ec.Challenges = ec.Challenges or {}
                ec.Challenges[encStr] = true
                pl:setHaloNote("Enclosure Unlocked!", 0, 255, 0, 255)
            end
        end
    end
    dialog:removeFromUIManager()
end

Events.OnFillWorldObjectContextMenu.Remove(EnclosureChallenge.Context)
Events.OnFillWorldObjectContextMenu.Add(EnclosureChallenge.Context)








--[[
function EnclosureChallenge.ConfirmDialog(pl, text, title, isQuit, isRemote, unlockTarg)
    pl = pl or getPlayer()
    if not pl or not text then return end

    -- Allow unlocks and quits even if already in a challenge
    if not isQuit and not unlockTarg and EnclosureChallenge.isChallenger() then return end

    EnclosureChallenge.disabler(true)
    getSoundManager():playUISound("EnclosureChallenge_Prompt")
    EnclosureChallenge.clearCoord()

    text = text:gsub("\\n", "\n")
    title = title or "Enclosure Challenge"

    local width, height = 300, 150
    local x = getCore():getScreenWidth() / 2 - width / 2
    local y = getCore():getScreenHeight() / 2 - height / 2
    local plNum = pl:getPlayerNum()

    local dialog

    local function onClick(_, button)
        EnclosureChallenge.disabler(false)

        if button.internal == "YES" then
            if unlockTarg then
                EnclosureChallenge.doUnlock(unlockTarg)
            else
                EnclosureChallenge.onYes(isQuit, isRemote)
            end
        elseif button.internal == "NO" then
            EnclosureChallenge.onNo(isQuit, isRemote)
        end

        if dialog then
            dialog:setVisible(false)
            dialog:removeFromUIManager()
        end
    end

    dialog = ISModalDialog:new(x, y, width, height, text, true, nil, onClick, plNum, 0, title)
    dialog.backgroundColor = { r = 0.6, g = 0.1, b = 0.1, a = 0.6 }
    dialog.borderColor = { r = 0, g = 0, b = 0, a = 1 }
    dialog:initialise()
    dialog:addToUIManager()
end
 ]]