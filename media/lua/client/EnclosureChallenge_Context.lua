--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

EnclosureChallenge = EnclosureChallenge or {}
-----------------------     context*          ---------------------------
function EnclosureChallenge.addCategorySubmenu(context, rootMenu, worldobjects)
	local pl = getPlayer()
	if not pl then return end

	local currentChoice = EnclosureChallenge.getRewardChoice()

	local subOpt = rootMenu:addOption(getText("ContextMenu_EnclosureChallenge_ChooseCategory"))
	subOpt.iconTexture = getTexture("media/ui/EnclosureChallenge_Rewards.png")
	local categSub = ISContextMenu:getNew(context)
	context:addSubMenu(subOpt, categSub)

	for i = 0, 14 do
		local title = EnclosureChallenge.getRewardTitle(i)
		if i == 0 or (title and title ~= "") then
			local label = (i == 0) and getText("Random") or tostring(title)
			local chance = EnclosureChallenge.getRewardChance(i)

			local opt = categSub:addOption(label, worldobjects, function()
				EnclosureChallenge.setRewardChoice(i)
				getSoundManager():playUISound("UIActivateMainMenuItem")
				context:hideAndChildren()
			end)

			local tip = ISWorldObjectContextMenu.addToolTip()
			tip.description = "Reward Chance: " .. tostring(chance)

			if i > 0 then
				local items = EnclosureChallenge.parseItems(i)
				if #items > 0 then
					tip.description = tip.description .. "\nItems:\n- " .. table.concat(items, "\n- ")
				end
			else
				tip.description = "100% Chance to win a random item across all categories"
			end

			opt.toolTip = tip

			if i == currentChoice then
				categSub:setOptionChecked(opt, true)
			end
		end
	end
end



function EnclosureChallenge.Context(plNum, context, worldobjects)
    local pl = getSpecificPlayer(plNum)
    local sq = clickedSquare
    if not pl or not sq then return end
    --if (sq == pl:getCurrentSquare()) or  getCore():getDebug() then
	local ec = EnclosureChallenge.getData()
	local remaining = ec.ChallengeTime or 0
	local isChallenger = EnclosureChallenge.isChallenger()
	EnclosureChallenge.getEnclosureStatus(sq)
	local mainOptStr = getText("ContextMenu_EnclosureChallenge")
	if isChallenger then
		if remaining > 1 then
			mainOptStr = mainOptStr .. "  Hrs: "..remaining
		else
			mainOptStr = mainOptStr .. "  Hr: "..remaining
		end
	end

	local mainOpt = context:addOptionOnTop(mainOptStr)
	mainOpt.iconTexture = getTexture("media/ui/EnclosureChallenge_Icon.png")
	local rootMenu = ISContextMenu:getNew(context)
	context:addSubMenu(mainOpt, rootMenu)
	-----------------------      unlock*      ---------------------------

	local isCanUnlock = EnclosureChallenge.isCanUnlock(sq)
	local encStr = EnclosureChallenge.getEnclosureStr(sq)
	local enc = EnclosureChallenge.getEnclosure(sq)
	local status = EnclosureChallenge.getEnclosureStatus(sq)
	local EnclosureX = enc.x
	local EnclosureY = enc.y
	local pts = ' [  Points: '.. tostring(EnclosureChallenge.getPoints())..' ]'
	local unlockTitle = getText("ContextMenu_EnclosureChallenge_Unlock")..pts
	local isConquered = status == "Conquered"
	local isUnlocked = status == "Unlocked"
	--local clickedOutside = not EnclosureChallenge.isSameEnclosure(sq)

	if isUnlocked then
		unlockTitle = "UNLOCKED: " .. tostring(pts)
	end

	local unlockOpt = rootMenu:addOption(unlockTitle, worldobjects, function()
		EnclosureChallenge.ConfirmDialog(pl, "Unlock Enclosure? [ " .. tostring(encStr) .. " ]", "Enclosure Challenge", false, false, sq)
		context:hideAndChildren()
	end)




	unlockOpt.notAvailable = not isCanUnlock
--[[
	if clickedOutside then
		UnlockNotAvailable = true
		local unlockOptTip = ISWorldObjectContextMenu.addToolTip()
		unlockOptTip.description = getText("ContextMenu_EnclosureChallenge_ClickedOutsideUnlock")
		unlockOpt.toolTip = unlockOptTip
	end ]]



	-----------------------      start*      ---------------------------

	local startHereOpt = rootMenu:addOption(getText("ContextMenu_EnclosureChallenge_StartHere"), worldobjects, function()

	--legacy sync function i used for mods v1
	--[[if isClient() then
			sendClientCommand("EnclosureChallenge", "prompt", { EnclosureX = EnclosureX, EnclosureY = EnclosureY, isRemote = false })
		end ]]


		EnclosureChallenge.ConfirmDialog(pl, "Accept Challenge?", "Enclosure Challenge", false, false)
		context:hideAndChildren()

	end)

	local startHereTip = ISWorldObjectContextMenu.addToolTip()
	if not isUnlocked then
		startHereTip.description = getText("ContextMenu_EnclosureChallenge_MustUnlock")  .. tostring(remaining)
	elseif isChallenger then
		startHereTip.description = getText("ContextMenu_EnclosureChallenge_Time")  .. tostring(remaining)
	elseif clickedOutside then
		startHereTip.description =  getText("ContextMenu_EnclosureChallenge_ClickedOutside")
	else
		startHereTip.description = getText("ContextMenu_EnclosureChallenge_Confirm")..'['.. tostring(encStr).."]"
	end

	startHereOpt.notAvailable =  clickedOutside or not isUnlocked or isChallenger or not  EnclosureChallenge.isSameEnclosure(sq) or isConquered
	startHereOpt.toolTip = startHereTip

	-----------------------  remote*          ---------------------------

	if not isChallenger and SandboxVars.EnclosureChallenge.AllowRemoteChallenge then
		local startRemoteOpt = rootMenu:addOption(getText("ContextMenu_EnclosureChallenge_StartRemote"), worldobjects, function()
			EnclosureChallenge.saveCoord()
			EnclosureChallenge.tpRandMidSq()
			context:hideAndChildren()

		end)
		local startRemoteTip = ISWorldObjectContextMenu.addToolTip()
		startRemoteTip.description = getText("ContextMenu_EnclosureChallenge_StartRemote_tip")
		startRemoteOpt.toolTip = startRemoteTip
	end

	-----------------------     quit*       ---------------------------
	if SandboxVars.EnclosureChallenge.AllowQuitChallenge then
		if isChallenger then
			local quitOpt = rootMenu:addOption(getText("ContextMenu_EnclosureChallenge_Quit"), worldobjects, function()
				context:hideAndChildren()
				EnclosureChallenge.ConfirmDialog(pl, "Forfeit Challenge", "Enclosure Challenge",  true, false)
			end)

			local quitTip = ISWorldObjectContextMenu.addToolTip()
			quitTip.description = getText("ContextMenu_EnclosureChallenge_Quit_tip")
			quitOpt.toolTip = quitTip
		end
	end
	-----------------------            ---------------------------

	if encStr then
		local cellInfo = getText("ContextMenu_EnclosureChallenge_Cell") .." ".. tostring(encStr)
		local cellOpt = rootMenu:addOptionOnTop(cellInfo, nil, nil)
		cellOpt.notAvailable = true

	end

	EnclosureChallenge.addCategorySubmenu(context, rootMenu, worldobjects)
	-----------------------    dbg        ---------------------------
	if getCore():getDebug() then
		local dbgOpt = rootMenu:addOption("Debug")
		local dbgSub = ISContextMenu:getNew(context)
		context:addSubMenu(dbgOpt, dbgSub)

		dbgSub:addOption("clipWhereami", worldobjects, function()
			EnclosureChallenge.clipWhereami()

		end)

		dbgSub:addOption("dbgWin - set hrs to 0", worldobjects, function()
			EnclosureChallenge.dbgWin()
			--EnclosureChallenge.doWin()
		end)

		dbgSub:addOption("dbgPts", worldobjects, function()
			EnclosureChallenge.dbgPts()

		end)

		dbgSub:addOption("debugData", worldobjects, function()
			EnclosureChallenge.debugData()

		end)

		dbgSub:addOption("resetData", worldobjects, function()
			EnclosureChallenge.resetData()
		end)

		dbgSub:addOption("setMarkers [keepold]", worldobjects, function()
			EnclosureChallenge.setMarkers(sq, true)
		end)
		dbgSub:addOption("setMarkers [clear old]", worldobjects, function()
			EnclosureChallenge.setMarkers(sq, false)
		end)

		dbgSub:addOption("storeRebound", worldobjects, function()
			EnclosureChallenge.storeRebound(pl)
		end)
		dbgSub:addOption("doReward", worldobjects, function()
			EnclosureChallenge.doReward()
		end)
		dbgSub:addOption("addChallengeSymbols", worldobjects, function()
			EnclosureChallenge.addChallengeSymbols(sq)

		end)



		dbgSub:addOption("rebound", worldobjects, function()
			EnclosureChallenge.rebound(pl)
		end)

		dbgSub:addOption("clearRebound", worldobjects, function()
			EnclosureChallenge.clearRebound()
		end)
		dbgSub:addOption("storeConquered", worldobjects, function()
			EnclosureChallenge.storeConquered(true)
		end)
		dbgSub:addOption("disabler false", worldobjects, function()
			EnclosureChallenge.disabler(false)
		end)


	end
end

Events.OnFillWorldObjectContextMenu.Remove(EnclosureChallenge.Context)
Events.OnFillWorldObjectContextMenu.Add(EnclosureChallenge.Context)
