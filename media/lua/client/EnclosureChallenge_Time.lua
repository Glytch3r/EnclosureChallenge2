--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]
require "lua_timers"

EnclosureChallenge = EnclosureChallenge or {}

function EnclosureChallenge.ChallengeTimer()
    local pl = getPlayer(); if not pl then return end
    local user = pl:getUsername()
    local ec = EnclosureChallenge.getData()
    if not ec then return false end
    if not EnclosureChallenge.isChallenger() then return false end

    if ec.ChallengeTime and ec.ChallengeTime > 0 then
        ec.ChallengeTime = ec.ChallengeTime - 1
    end

    local isRemote = EnclosureChallenge.isRemoteMode()
    local encStr = isRemote and ec.RemoteChallenge or ec.AdditiveChallenge

    if ec.ChallengeTime == 0 and encStr ~= "" then
        if EnclosureChallenge.isShouldAnnounce() then
            local enc = EnclosureChallenge.getEnclosureXY(pl:getX(), pl:getY())
            local posStr = ""
            if enc and SandboxVars.EnclosureChallenge.CoordNotif then
                posStr = string.format(": [%d, %d]", enc.x, enc.y)
            end
            local msg = string.format("%s %s  %s", user, getText("ContextMenu_EnclosureChallenge_Conquer"), posStr)
            if isClient() then
                processGeneralMessage(msg)
            else
                pl:setHaloNote(msg, 150, 250, 150, 900)
            end
        end

        if pl:isAlive() then
            EnclosureChallenge.doWin(isRemote)
            ec.AdditiveChallenge = ""
            ec.RemoteChallenge = ""
        end

        if getCore():getDebug() then print("WIN") end
    end
end
Events.EveryHours.Add(EnclosureChallenge.ChallengeTimer)
--[[
function EnclosureChallenge.ChallengeTimer()
    local pl = getPlayer()
    local user = pl:getUsername()

    local ec =  EnclosureChallenge.getData()
    if not EnclosureChallenge.isChallenger() then return false end
    if ec and ec.ChallengeTime and ec.ChallengeTime > 0 then
        ec.ChallengeTime = ec.ChallengeTime - 1
        if ec.ChallengeTime <= 0 then

            if EnclosureChallenge.isShouldAnnounce() then
                local enc = EnclosureChallenge.getEnclosureXY( pl:getX(),   pl:getY())
                if not enc then return end
                local EnclosureX = enc.x
                local EnclosureY = enc.y

                local posStr = (EnclosureX and EnclosureY) and ": [" .. EnclosureX .. ", " .. EnclosureY .. "]" or ""
                if not SandboxVars.EnclosureChallenge.CoordNotif then
                    posStr = ""
                end
                local msg = tostring(user) .. " " .. getText("ContextMenu_EnclosureChallenge_Conquer").. "  ".. tostring(posStr)
                if isClient() then
                    processGeneralMessage(msg)
                else
                    pl:setHaloNote(msg, 150, 250, 150, 900)
                end
            end


            if pl:isAlive() then
                EnclosureChallenge.doWin()
            end

            if getCore():getDebug() then
                print("WIN")

            end
        end
	end

            --EnclosureChallenge.setChallenge(false, false)
end
Events.EveryHours.Add(EnclosureChallenge.ChallengeTimer) ]]
-----------------------            ---------------------------
function EnclosureChallenge.getSec()
    local cal = PZCalendar and PZCalendar.getInstance and PZCalendar.getInstance()
    if cal and Calendar and Calendar.SECOND then
        return cal:get(Calendar.SECOND)
    end
    return nil
end

--[[ function EnclosureChallenge.clock()
    local prevSec = EnclosureChallenge.getSec()
    function EnclosureChallenge.clockHandler()
        local curSec = EnclosureChallenge.getSec()
        if prevSec < curSec or (curSec == 1 and (prevSec == 60 or prevSec > curSec)) then
            triggerEvent("OnClockUpdate")
            prevSec = curSec
        end
    end
    Events.OnTick.Add(EnclosureChallenge.clockHandler)
end ]]
-----------------------            ---------------------------
function EnclosureChallenge.countdown()
    local pl = getPlayer()
    if not EnclosureChallenge.isChallenger() then return end
    --EnclosureChallenge.time = EnclosureChallenge.time or SandboxVars.EnclosureChallenge.CountdownSeconds
    EnclosureChallenge.time = 30
    if EnclosureChallenge.time <= 0 then
        EnclosureChallenge.time = nil
        if EnclosureChallenge.isOutOfBounds(pl) then
            EnclosureChallenge.ContinueDialog(pl, getText("ContextMenu_EnclosureChallenge_Next"), "Enclosure Challenge", function(button)
                if button.internal == "YES" then
                    --EnclosureChallenge.setExtendedChallenge(true)
                else
                    --EnclosureChallenge.setChallenge(false, false)
                end
            end)
        else
            --EnclosureChallenge.setChallenge(false, false)
        end
    else
        EnclosureChallenge.time = EnclosureChallenge.time - 1
        getSoundManager():playUISound("EnclosureChallenge_Count")
        ISChat.instance.servermsgTimer = 5000
        ISChat.instance.servermsg = tostring(EnclosureChallenge.time)
    end
end

--[[

function EnclosureChallenge.countdown()
    local pl = getPlayer()
    if not EnclosureChallenge.isChallenger() then return end
    EnclosureChallenge.time = EnclosureChallenge.time or SandboxVars.EnclosureChallenge.CountdownSeconds

    if EnclosureChallenge.time <= 0 then
        EnclosureChallenge.time = nil
        if EnclosureChallenge.isOutOfBounds(pl) then
            -- Show dialog, actual extension only on YES click in dialog
            EnclosureChallenge.ContinueDialog(pl, getText("ContextMenu_EnclosureChallenge_Next"), "Enclosure Challenge")
        else
            --EnclosureChallenge.setChallenge(false, false)
        end
    else
        EnclosureChallenge.time = EnclosureChallenge.time - 1
        getSoundManager():playUISound("EnclosureChallenge_Count")

        ISChat.instance.servermsgTimer = 5000
        ISChat.instance.servermsg = tostring(EnclosureChallenge.time)
    end
end
--Events.OnClockUpdate.Add(EnclosureChallenge.countdown)
 ]]