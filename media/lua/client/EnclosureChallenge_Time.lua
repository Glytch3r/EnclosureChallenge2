--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]
require "lua_timers"

EnclosureChallenge = EnclosureChallenge or {}

function EnclosureChallenge.getTimeStr()
    local ec = EnclosureChallenge.getData()
    if not ec or not EnclosureChallenge.isChallenger() then return "" end

    if EnclosureChallenge.isRemoteMode() then
        local time = ec.RemoteTime
        if time and time > 0 then
            return (time == 1) and "Final Hour" or ("Hours Remaining: " .. tostring(time))
        end
    elseif EnclosureChallenge.isAdditiveMode() then
        local time = ec.AdditiveTime or 0
        return "Survived for " .. tostring(time) .. " Hour" .. ((time == 1) and "" or "s")
    end

    return ""
end

function EnclosureChallenge.RemoteTimer()
    local pl = getPlayer(); if not pl then return end
    local ec = EnclosureChallenge.getData()
    if not ec or not EnclosureChallenge.isChallenger() then return end

    if (ec.RemoteTime or 0) > 0 then
        ec.RemoteTime = ec.RemoteTime - 1
    end

    if ec.RemoteTime <= 0 and ec.RemoteChallenge and ec.RemoteChallenge ~= "" then
        if pl:isAlive() then
            if EnclosureChallenge.isShouldAnnounce() then
                local enc = EnclosureChallenge.getEnclosureXY(pl:getX(), pl:getY())
                local posStr = (enc and SandboxVars.EnclosureChallenge.CoordNotif)
                    and string.format(": [%d, %d]", enc.x, enc.y) or ""
                local msg = string.format("%s %s  %s", pl:getUsername(), getText("ContextMenu_EnclosureChallenge_Conquer"), posStr)
                if isClient() then
                    processGeneralMessage(msg)
                else
                    pl:setHaloNote(msg, 150, 250, 150, 900)
                end
            end
            if getCore():getDebug() then print("WIN") end
            EnclosureChallenge.doWin()
            ec.RemoteChallenge = ""
        end
        Events.EveryHours.Remove(EnclosureChallenge.RemoteTimer)
    end
end

function EnclosureChallenge.AdditiveTimer()
    local pl = getPlayer(); if not pl then return end
    local ec = EnclosureChallenge.getData()
    if not ec or not EnclosureChallenge.isChallenger() then return end

    local encStr = ec.AdditiveChallenge
    if not encStr or encStr == "" then
        ec.AdditiveTime = 0
        Events.EveryHours.Remove(EnclosureChallenge.AdditiveTimer)
        return
    end

    ec.AdditiveTime = (ec.AdditiveTime or 0) + 1
    local milestone = SandboxVars.EnclosureChallenge.ChallengeHours or 168
    if ec.AdditiveTime % milestone == 0 then
        ec.AdditiveWins = (ec.AdditiveWins or 0) + 1

        if pl:isAlive() then
            if EnclosureChallenge.isShouldAnnounce() then
                local enc = EnclosureChallenge.getEnclosureXY(pl:getX(), pl:getY())
                local posStr = (enc and SandboxVars.EnclosureChallenge.CoordNotif)
                    and string.format(": [%d, %d]", enc.x, enc.y) or ""
                local msg = string.format("%s %s  %s", pl:getUsername(), getText("ContextMenu_EnclosureChallenge_Conquer"), posStr)
                if isClient() then
                    processGeneralMessage(msg)
                else
                    pl:setHaloNote(msg, 150, 250, 150, 900)
                end
            end
            if getCore():getDebug() then print("WIN") end
            EnclosureChallenge.doWin()
        end
    end
end



-----------------------            ---------------------------
function EnclosureChallenge.getSec()
    local cal = PZCalendar and PZCalendar.getInstance and PZCalendar.getInstance()
    if cal and Calendar and Calendar.SECOND then
        return cal:get(Calendar.SECOND)
    end
    return nil
end

--[[ function EnclosureChallenge.clock()
    local prevSec = EnclosureChallenge.getSec()
    function EnclosureChallenge.clockHandler()
        local curSec = EnclosureChallenge.getSec()
        if prevSec < curSec or (curSec == 1 and (prevSec == 60 or prevSec > curSec)) then
            triggerEvent("OnClockUpdate")
            prevSec = curSec
        end
    end
    Events.OnTick.Add(EnclosureChallenge.clockHandler)
end ]]
-----------------------            ---------------------------
--[[
function EnclosureChallenge.countdown()
    local pl = getPlayer()
    if not EnclosureChallenge.isChallenger() then return end
    --EnclosureChallenge.time = EnclosureChallenge.time or SandboxVars.EnclosureChallenge.CountdownSeconds
    EnclosureChallenge.time = 30
    if EnclosureChallenge.time <= 0 then
        EnclosureChallenge.time = nil
        if EnclosureChallenge.isOutOfBounds(pl) then
            EnclosureChallenge.ContinueDialog(pl, getText("ContextMenu_EnclosureChallenge_Next"), "Enclosure Challenge", function(button)
                if button.internal == "YES" then
                    --EnclosureChallenge.setExtendedChallenge(true)
                else
                    --EnclosureChallenge.setChallenge(false, false)
                end
            end)
        else
            --EnclosureChallenge.setChallenge(false, false)
        end
    else
        EnclosureChallenge.time = EnclosureChallenge.time - 1
        getSoundManager():playUISound("EnclosureChallenge_Count")
        ISChat.instance.servermsgTimer = 5000
        ISChat.instance.servermsg = tostring(EnclosureChallenge.time)
    end
end
 ]]
--[[

function EnclosureChallenge.countdown()
    local pl = getPlayer()
    if not EnclosureChallenge.isChallenger() then return end
    EnclosureChallenge.time = EnclosureChallenge.time or SandboxVars.EnclosureChallenge.CountdownSeconds

    if EnclosureChallenge.time <= 0 then
        EnclosureChallenge.time = nil
        if EnclosureChallenge.isOutOfBounds(pl) then
            -- Show dialog, actual extension only on YES click in dialog
            EnclosureChallenge.ContinueDialog(pl, getText("ContextMenu_EnclosureChallenge_Next"), "Enclosure Challenge")
        else
            --EnclosureChallenge.setChallenge(false, false)
        end
    else
        EnclosureChallenge.time = EnclosureChallenge.time - 1
        getSoundManager():playUISound("EnclosureChallenge_Count")

        ISChat.instance.servermsgTimer = 5000
        ISChat.instance.servermsg = tostring(EnclosureChallenge.time)
    end
end
--Events.OnClockUpdate.Add(EnclosureChallenge.countdown)
 ]]